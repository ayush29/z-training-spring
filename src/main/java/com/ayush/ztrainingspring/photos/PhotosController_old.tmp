package com.ayush.ztrainingspring.photos;

import org.apache.commons.io.IOUtils;
import org.apache.tomcat.util.http.fileupload.ByteArrayOutputStream;
// import org.apache.tomcat.util.http.fileupload.IOUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;


@CrossOrigin(origins = "*")
@RestController
@RequestMapping(path="/photos") // This means URL's start with /photos (after Application path)
public class PhotosController {

    // private static String UPLOADED_FOLDER = "src/main/resources/photos_storage/";
    private static String UPLOADED_FOLDER = "photos_storage/";

    @Autowired // This means to get the bean called userRepository
    // Which is auto-generated by Spring, we will use it to handle the data
    private PhotosRepository photosRepository;

    @GetMapping(path="/all")
    public @ResponseBody Iterable<Photo> getAllPhotos() {
        // This returns a JSON or XML with the users
        return photosRepository.findAll();
    }
    
    @GetMapping(path="/test")
    public String getTemp() {
        // This returns a JSON or XML with the users
        return "ss";
    }

    @GetMapping(path="/{category}")
    public @ResponseBody Iterable<Photo> getCatPhotos(@PathVariable String category) {
        // This returns a JSON or XML with the users
        return photosRepository.findByCategoryEquals(category);
    }

    @PostMapping("/upload") // //new annotation since 4.3
    public String singleFileUpload(@RequestParam("file") MultipartFile file,
                                   @RequestParam("category") String category,
                                   RedirectAttributes redirectAttributes) {

        if (file.isEmpty()) {
            return "Please select a file to upload";
        }

        Photo n = new Photo();


        n.setCategory(category);
        n.setLink(UPLOADED_FOLDER);
        photosRepository.save(n);

        int id = n.getId();
        // System.out.println("----------Working Directory------------- = " + System.getProperty("user.dir"));

        String file_ext = file.getOriginalFilename().split("\\.", -1)[1]; ;
        String file_name = Integer.toString(id) + "." + file_ext;

        n.setLink("http://localhost:8080/photos/get-image-with-media-type/" + file_name);
        photosRepository.save(n);



        String uploadStatus = "";

        try {

            // Get the file and save it somewhere

            byte[] bytes = file.getBytes();
            Path path = Paths.get(UPLOADED_FOLDER + file_name);
            Files.write(path, bytes);

            uploadStatus = "You successfully uploaded '" + file_name + "'";

        } catch (IOException e) {
            e.printStackTrace();
        }

        return uploadStatus;
    }
    
    @GetMapping(
      value = "/get-image-with-media-type/{imgName}",
      produces = MediaType.IMAGE_JPEG_VALUE
    )
    public @ResponseBody byte[] getImageWithMediaType(@PathVariable String imgName) throws IOException {    
        final InputStream in = new FileInputStream("photos_storage/" + imgName); //getClass().getResourceAsStream("/photos_storage/" + imgName);
        return IOUtils.toByteArray(in);
    }
    
}
